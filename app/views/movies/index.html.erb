<% content_for :title, "Quản lý Phim" %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>Quản lý Phim</h1>
  <%= link_to "Thêm phim mới", new_movie_path, class: "btn btn-primary" %>
</div>

<!-- Search and Filter Form -->
<div class="card mb-4">
  <div class="card-body">
    <%= form_with url: movies_path, method: :get, local: true, class: "row g-3" do |form| %>
      <div class="col-md-4">
        <%= form.text_field :search, value: params[:search],
                            placeholder: "Tìm kiếm theo tên phim...",
                            class: "form-control" %>
      </div>
      <div class="col-md-3">
        <%= form.select :genre, options_for_select([["Tất cả thể loại", ""]] + @genres.map { |g| [g.humanize, g] }, params[:genre]),
                        {}, { class: "form-select" } %>
      </div>
      <div class="col-md-3">
        <%= form.select :sort, options_for_select([
                                                    ["Mới nhất", "created_at DESC"],
                                                    ["Cũ nhất", "created_at ASC"],
                                                    ["Tên A-Z", "title ASC"],
                                                    ["Tên Z-A", "title DESC"]
                                                  ], params[:sort]), {}, { class: "form-select" } %>
      </div>
      <div class="col-md-2">
        <%= form.submit "Tìm kiếm", class: "btn btn-outline-primary w-100" %>
      </div>
    <% end %>
  </div>
</div>

<!-- Bulk Actions Form -->
<%= form_with url: bulk_actions_movies_path, method: :get, local: true, id: "bulk-form" do |form| %>
  <div class="card mb-4">
    <div class="card-body">
      <div class="row align-items-end">
        <div class="col-md-6">
          <%= form.select :bulk_action, options_for_select([
                                                             ["Chọn hành động", ""],
                                                             ["Kích hoạt", "activate"],
                                                             ["Vô hiệu hóa", "deactivate"],
                                                             ["Xóa", "delete"]
                                                           ]), {}, { class: "form-select" } %>
        </div>
        <div class="col-md-6">
          <%= form.submit "Thực hiện", class: "btn btn-warning",
                          onclick: "return confirm('Bạn có chắc chắn muốn thực hiện hành động này?')" %>
        </div>
      </div>
    </div>
  </div>

  <!-- Movies Table -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>Danh sách phim (<%= @total_movies %> phim)</span>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="select-all">
        <label class="form-check-label" for="select-all">
          Chọn tất cả
        </label>
      </div>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
          <tr>
            <th width="40"></th>
            <th width="80">Poster</th>
            <th>Tên phim</th>
            <th>Thể loại</th>
            <th>Thời lượng</th>
            <th>Độ tuổi</th>
            <th>Trạng thái</th>
            <th>Suất chiếu</th>
            <th width="200">Thao tác</th>
          </tr>
          </thead>
          <tbody>
          <% @movies.each do |movie| %>
            <tr>
              <td>
                <div class="form-check">
                  <%= check_box_tag "movie_ids[]", movie.id, false,
                                    class: "form-check-input movie-checkbox" %>
                </div>
              </td>
              <td>
                <% if movie.poster_url.present? || movie.poster_image.present? %>
                  <img src="<%= movie.poster_url || url_for(movie.poster_image) %>"
                       alt="<%= movie.title %>"
                       class="img-thumbnail"
                       style="width: 60px; height: 80px; object-fit: cover;">
                <% else %>
                  <div class="bg-light d-flex align-items-center justify-content-center"
                       style="width: 60px; height: 80px;">
                    <i class="fas fa-image text-muted"></i>
                  </div>
                <% end %>
              </td>
              <td>
                <strong><%= link_to movie.title, movie_path(movie) %></strong>
                <br>
                <small class="text-muted">
                  Tạo: <%= movie.created_at.strftime("%d/%m/%Y") %>
                </small>
              </td>
              <td>
                <span class="badge bg-info"><%= movie.genre.humanize %></span>
              </td>
              <td><%= movie.duration %> phút</td>
              <td>
                <span class="badge bg-secondary"><%= movie.age_rating %></span>
              </td>
              <td>
                <% case movie.status %>
                <% when 'active' %>
                  <span class="badge bg-success">Đang chiếu</span>
                <% when 'inactive' %>
                  <span class="badge bg-secondary">Không hoạt động</span>
                <% when 'coming_soon' %>
                  <span class="badge bg-warning">Sắp chiếu</span>
                <% end %>
              </td>
              <td>
                <%= movie.showtimes.where('show_date >= ?', Date.current).count %> suất
              </td>
              <td>
                <div class="btn-group" role="group">
                  <%= link_to movie_path(movie), class: "btn btn-sm btn-outline-primary" do %>
                    <i class="fas fa-eye"></i>
                  <% end %>
                  <%= link_to edit_movie_path(movie), class: "btn btn-sm btn-outline-warning" do %>
                    <i class="fas fa-edit"></i>
                  <% end %>
                  <%= link_to toggle_status_movie_path(movie),
                              method: :post,
                              class: "btn btn-sm btn-outline-info",
                              title: "Chuyển trạng thái" do %>
                    <i class="fas fa-toggle-on"></i>
                  <% end %>
                  <%= link_to movie_path(movie),
                              method: :delete,
                              class: "btn btn-sm btn-outline-danger",
                              confirm: "Bạn có chắc chắn muốn xóa phim này?",
                              title: "Xóa" do %>
                    <i class="fas fa-trash"></i>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
<% end %>

<!-- Pagination -->
<div class="d-flex justify-content-center mt-4">
  <%= paginate @movies if respond_to?(:paginate) %>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const selectAllCheckbox = document.getElementById('select-all');
        const movieCheckboxes = document.querySelectorAll('.movie-checkbox');

        selectAllCheckbox.addEventListener('change', function() {
            movieCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });

        movieCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const checkedCount = document.querySelectorAll('.movie-checkbox:checked').length;
                selectAllCheckbox.checked = checkedCount === movieCheckboxes.length;
                selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < movieCheckboxes.length;
            });
        });
    });
</script>