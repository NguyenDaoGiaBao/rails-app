<% content_for :title, "Quản lý Phim" %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>Quản lý Phim</h1>
  <%= link_to "Thêm phim mới", new_movie_path, class: "btn btn-primary" %>
</div>

<!-- Search and Filter Form -->
<div class="card mb-4">
  <div class="card-body">
    <%= form_with url: movies_path, method: :get, local: true, class: "row g-3" do |form| %>
      <div class="col-md-4">
        <%= form.text_field :search, value: params[:search],
                            placeholder: "Tìm kiếm theo tên phim...",
                            class: "form-control" %>
      </div>
      <div class="col-md-3">
        <%= form.select :genre, options_for_select([["Tất cả thể loại", ""]] + @genres.map { |g| [g.humanize, g] }, params[:genre]),
                        {}, { class: "form-select" } %>
      </div>
      <div class="col-md-3">
        <%= form.select :sort, options_for_select([
                                                    ["Mới nhất", "created_at DESC"],
                                                    ["Cũ nhất", "created_at ASC"],
                                                    ["Tên A-Z", "title ASC"],
                                                    ["Tên Z-A", "title DESC"]
                                                  ], params[:sort]), {}, { class: "form-select" } %>
      </div>
      <div class="col-md-2 d-flex align-items-center">
        <%= form.submit "Tìm kiếm", class: "btn btn-outline-primary w-100" %>
      </div>
    <% end %>
  </div>
</div>

<!-- Bulk Actions Form -->
  <!-- Movies Table -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>Danh sách phim (<%= @total_movies %> phim)</span>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
          <tr>
            <th width="40">STT</th>
            <th width="80">Poster</th>
            <th>Tên phim</th>
            <th>Thể loại</th>
            <th>Thời lượng</th>
            <th>Độ tuổi</th>
            <th>Trạng thái</th>
            <th>Suất chiếu</th>
            <th width="200">Thao tác</th>
          </tr>
          </thead>
          <tbody>
          <% @movies.each do |movie| %>
            <tr>
              <td>
                <%= movie.id %>
              </td>
              <td>
                <% if movie.poster_url.present? || movie.poster_image.present? %>
                  <img src="<%= movie.poster_url || url_for(movie.poster_image) %>"
                       alt="<%= movie.title %>"
                       class="img-thumbnail"
                       style="width: 60px; height: 80px; object-fit: cover;">
                <% else %>
                  <div class="bg-light d-flex align-items-center justify-content-center"
                       style="width: 60px; height: 80px;">
                    <i class="fas fa-image text-muted"></i>
                  </div>
                <% end %>
              </td>
              <td>
                <strong><%= link_to movie.title, movie_path(movie) %></strong>
                <br>
                <small class="text-muted">
                  Tạo: <%= movie.created_at.strftime("%d/%m/%Y") %>
                </small>
              </td>
              <td>
                <span class="badge bg-info"><%= movie.genre.humanize %></span>
              </td>
              <td><%= movie.duration %> phút</td>
              <td>
                <span class="badge bg-secondary"><%= movie.age_rating %></span>
              </td>
              <td>
                <% case movie.status %>
                <% when 'active' %>
                  <span class="badge bg-success">Đang chiếu</span>
                <% when 'inactive' %>
                  <span class="badge bg-secondary">Không hoạt động</span>
                <% when 'coming_soon' %>
                  <span class="badge bg-warning">Sắp chiếu</span>
                <% end %>
              </td>
              <td>
                <%= movie.showtimes.where('show_date >= ?', Date.current).count %> suất
              </td>
              <td>
                <div class="btn-group" role="group">
                  <%= link_to movie_path(movie), class: "btn btn-sm btn-outline-primary" do %>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-eye">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                      <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                  <% end %>
                  <%= link_to edit_movie_path(movie), class: "btn btn-sm btn-outline-warning" do %>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2">
                      <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                    </svg>
                  <% end %>
                  <%# link_to toggle_status_movie_path(movie),
                              method: :post,
                              class: "btn btn-sm btn-outline-info",
                              title: "Chuyển trạng thái" do %>
                  <%# <i class="fas fa-toggle-on"></i>
                  <% end %>
                  <%= link_to "#",
                      class: "btn btn-sm btn-outline-danger btn-delete-movie",
                      data: { id: movie.id, url: movie_path(movie) },
                      title: "Xóa" do %>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash-2">
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                      <line x1="10" y1="11" x2="10" y2="17"></line>
                      <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

<!-- Pagination -->
<div class="d-flex justify-content-center mt-4">
  <%= paginate @movies if respond_to?(:paginate) %>
</div>
<% content_for :scripts do %>
  <%= javascript_include_tag "custom-sweetalert" %>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.btn-delete-movie').forEach(function(button) {
            button.addEventListener('click', function(e) {
                e.preventDefault();

                const url = this.dataset.url;

                Swal.fire({
                    title: 'Bạn có chắc muốn xóa?',
                    text: "Hành động này không thể hoàn tác!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#e7515a',
                    cancelButtonColor: '#3b3f5c',
                    confirmButtonText: 'Vâng, xóa nó!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        const form = document.createElement('form');
                        form.method = 'post';
                        form.action = url;

                        const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
                        const csrfInput = document.createElement('input');
                        csrfInput.type = 'hidden';
                        csrfInput.name = 'authenticity_token';
                        csrfInput.value = csrfToken;
                        form.appendChild(csrfInput);

                        // input method delete
                        const methodInput = document.createElement('input');
                        methodInput.type = 'hidden';
                        methodInput.name = '_method';
                        methodInput.value = 'delete';
                        form.appendChild(methodInput);

                        document.body.appendChild(form);
                        form.submit();
                    }
                });
            });
        });
    });


    document.addEventListener('DOMContentLoaded', function() {
        const selectAllCheckbox = document.getElementById('select-all');
        const movieCheckboxes = document.querySelectorAll('.movie-checkbox');

        selectAllCheckbox.addEventListener('change', function() {
            movieCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });

        movieCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const checkedCount = document.querySelectorAll('.movie-checkbox:checked').length;
                selectAllCheckbox.checked = checkedCount === movieCheckboxes.length;
                selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < movieCheckboxes.length;
            });
        });
    });
</script>
<% end %>