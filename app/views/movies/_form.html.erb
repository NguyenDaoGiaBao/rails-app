<%= form_with(model: @movie, local: true, multipart: true, class: "needs-validation", novalidate: true) do |form| %>
  <% if @movie.errors.any? %>
    <div class="alert alert-danger" role="alert">
      <h5 class="alert-heading">
        <i class="fas fa-exclamation-circle me-2"></i>
        Có <%= pluralize(@movie.errors.count, "lỗi") %> cần khắc phục:
      </h5>
      <ul class="mb-0">
        <% @movie.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="row">
    <div class="col-lg-8">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">Thông tin cơ bản</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <%= form.label :title, "Tên phim", class: "form-label required" %>
            <%= form.text_field :title, class: "form-control #{'is-invalid' if @movie.errors[:title].any?}", required: true %>
            <div class="invalid-feedback d-block">
              <%= @movie.errors[:title].first if @movie.errors[:title].any? %>
            </div>
          </div>

          <div class="mb-3">
            <%= form.label :description, "Mô tả phim", class: "form-label" %>
            <%= form.text_area :description, rows: 6, class: "form-control #{'is-invalid' if @movie.errors[:description].any?}" %>
            <div class="form-text">Mô tả chi tiết về nội dung phim</div>
            <div class="invalid-feedback d-block">
              <%= @movie.errors[:description].first if @movie.errors[:description].any? %>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <%= form.label :genre, "Thể loại", class: "form-label required" %>
                <%= form.select :genre,
                                options_for_select([
                                                     ["Hành động", "action"],
                                                     ["Hài kịch", "comedy"],
                                                     ["Chính kịch", "drama"],
                                                     ["Kinh dị", "horror"],
                                                     ["Lãng mạn", "romance"],
                                                     ["Khoa học viễn tưởng", "sci_fi"],
                                                     ["Phiêu lưu", "adventure"],
                                                     ["Tài liệu", "documentary"],
                                                     ["Gia đình", "family"],
                                                     ["Hoạt hình", "animation"]
                                                   ], @movie.genre),
                                { prompt: "Chọn thể loại" },
                                { class: "form-select #{'is-invalid' if @movie.errors[:genre].any?}", required: true } %>
                <div class="invalid-feedback d-block">
                  <%= @movie.errors[:genre].first if @movie.errors[:genre].any? %>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <%= form.label :duration, "Thời lượng (phút)", class: "form-label required" %>
                <%= form.number_field :duration, class: "form-control #{'is-invalid' if @movie.errors[:duration].any?}", min: 1, required: true %>
                <div class="invalid-feedback d-block">
                  <%= @movie.errors[:duration].first if @movie.errors[:duration].any? %>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <%= form.label :age_rating, "Độ tuổi", class: "form-label required" %>
                <%= form.select :age_rating,
                                options_for_select([
                                                     ["P - Phù hợp mọi lứa tuổi", "P"],
                                                     ["K - Dành cho trẻ em dưới 13 tuổi", "K"],
                                                     ["T13 - Từ 13 tuổi trở lên", "T13"],
                                                     ["T16 - Từ 16 tuổi trở lên", "T16"],
                                                     ["T18 - Từ 18 tuổi trở lên", "T18"],
                                                     ["C - Cấm chiếu", "C"]
                                                   ], @movie.age_rating),
                                { prompt: "Chọn độ tuổi" },
                                { class: "form-select #{'is-invalid' if @movie.errors[:age_rating].any?}", required: true } %>
                <div class="invalid-feedback d-block">
                  <%= @movie.errors[:age_rating].first if @movie.errors[:age_rating].any? %>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <%= form.label :status, "Trạng thái", class: "form-label required" %>
                <%= form.select :status,
                                options_for_select([
                                                     ["Đang chiếu", "active"],
                                                     ["Sắp chiếu", "coming_soon"],
                                                     ["Không hoạt động", "inactive"]
                                                   ], @movie.status),
                                { prompt: "Chọn trạng thái" },
                                { class: "form-select #{'is-invalid' if @movie.errors[:status].any?}", required: true } %>
                <div class="invalid-feedback d-block">
                  <%= @movie.errors[:status].first if @movie.errors[:status].any? %>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Description Images Card -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">Hình ảnh mô tả</h5>
        </div>
        <div class="card-body">
          <!-- Existing Description Images -->
          <% if @movie.description_images.attached? %>
            <div class="mb-3">
              <label class="form-label">Hình ảnh hiện tại</label>
              <div class="row" id="existing-images">
                <% @movie.description_images.each_with_index do |image, index| %>
                  <div class="col-md-4 col-sm-6 mb-3" data-image-id="<%= image.id %>">
                    <div class="card">
                      <img src="<%= rails_blob_path(image, only_path: true) %>"
                           class="card-img-top"
                           style="height: 150px; object-fit: cover;"
                           alt="Description image <%= index + 1 %>">
                      <div class="card-body p-2">
                        <button type="button"
                                class="btn btn-sm btn-danger w-100"
                                onclick="removeExistingImage(<%= image.id %>, this)">
                          <i class="fas fa-trash me-1"></i>Xóa
                        </button>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>

          <!-- Upload New Description Images -->
          <div class="mb-3">
            <%= form.label :description_images, "Thêm hình ảnh mô tả", class: "form-label" %>
            <%= form.file_field :description_images,
                                multiple: true,
                                accept: "image/*",
                                class: "form-control #{'is-invalid' if @movie.errors[:description_images].any?}",
                                id: "description-images-input" %>
            <div class="form-text">Chọn nhiều file ảnh từ máy tính (JPG, PNG, GIF). Giữ Ctrl để chọn nhiều file.</div>
            <div class="invalid-feedback d-block">
              <%= @movie.errors[:description_images].first if @movie.errors[:description_images].any? %>
            </div>
          </div>

          <!-- Preview New Images -->
          <div id="new-images-preview" class="row"></div>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">Poster phim</h5>
        </div>
        <div class="card-body">
          <!-- Current Poster Preview -->
          <div class="mb-3">
            <div id="poster-preview" class="text-center">
              <% if @movie.poster_image.attached? && @movie.poster_image.blob.persisted? %>
                <img src="<%= rails_blob_path(@movie.poster_image, only_path: true) %>"
                     alt="Current poster"
                     class="img-fluid rounded mb-3"
                     style="max-height: 300px;" />
              <% else %>
                <div class="bg-light d-flex align-items-center justify-content-center rounded mb-3"
                     style="height: 300px;"
                     id="placeholder-poster">
                  <div class="text-center">
                    <i class="fas fa-image fa-3x text-muted mb-2"></i>
                    <p class="text-muted">Chưa có poster</p>
                  </div>
                </div>
              <% end %>
            </div>
          </div>

          <!-- Upload Image File -->
          <div class="mb-3">
            <%= form.label :poster_image, "Tải lên file ảnh", class: "form-label" %>
            <%= form.file_field :poster_image,
                                accept: "image/*",
                                class: "form-control #{'is-invalid' if @movie.errors[:poster_image].any?}",
                                id: "poster-file-input" %>
            <div class="form-text">Chọn file ảnh từ máy tính (JPG, PNG, GIF)</div>
            <div class="invalid-feedback d-block">
              <%= @movie.errors[:poster_image].first if @movie.errors[:poster_image].any? %>
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="card">
        <div class="card-body">
          <div class="d-grid gap-2">
            <%= form.submit @movie.new_record? ? "Tạo phim" : "Cập nhật phim",
                            class: "btn btn-primary btn-lg" %>
            <%= link_to "Hủy bỏ",
                        @movie.persisted? ? movie_path(@movie) : movies_path,
                        class: "btn btn-secondary" %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden fields for images to be removed -->
  <div id="images-to-remove"></div>
<% end %>

<style>
    .required::after {
        content: " *";
        color: red;
    }

    .image-preview-item {
        position: relative;
        margin-bottom: 15px;
    }

    .image-preview-item .remove-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        z-index: 10;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const posterFileInput = document.getElementById('poster-file-input');
        const descriptionImagesInput = document.getElementById('description-images-input');
        const posterPreview = document.getElementById('poster-preview');
        const newImagesPreview = document.getElementById('new-images-preview');
        let imagesToRemove = [];

        // Handle poster upload preview
        posterFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    updatePosterPreview(e.target.result);
                };
                reader.readAsDataURL(file);
            }
        });

        // Handle description images preview
        descriptionImagesInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            newImagesPreview.innerHTML = ''; // Clear previous previews

            if (files.length > 0) {
                files.forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        addImagePreview(e.target.result, index, file.name);
                    };
                    reader.readAsDataURL(file);
                });
            }
        });

        function updatePosterPreview(src) {
            posterPreview.innerHTML = `
                <img src="${src}"
                     alt="Poster preview"
                     class="img-fluid rounded mb-3"
                     style="max-height: 300px;"
                     onerror="showPlaceholder();">
            `;
        }

        function addImagePreview(src, index, filename) {
            const previewHtml = `
                <div class="col-md-4 col-sm-6 mb-3 image-preview-item" data-index="${index}">
                    <div class="card">
                        <img src="${src}"
                             class="card-img-top"
                             style="height: 150px; object-fit: cover;"
                             alt="${filename}">
                        <div class="card-body p-2">
                            <button type="button"
                                    class="btn btn-sm btn-danger w-100 remove-btn"
                                    onclick="removeNewImage(${index})">
                                <i class="fas fa-trash me-1"></i>Xóa
                            </button>
                            <small class="text-muted d-block mt-1" style="font-size: 0.75rem;">
                                ${filename.length > 20 ? filename.substring(0, 20) + '...' : filename}
                            </small>
                        </div>
                    </div>
                </div>
            `;
            newImagesPreview.insertAdjacentHTML('beforeend', previewHtml);
        }

        // Remove new image from preview
        window.removeNewImage = function(index) {
            const imageElement = document.querySelector(`[data-index="${index}"]`);
            if (imageElement) {
                imageElement.remove();
            }

            // Create new FileList without the removed file
            const dt = new DataTransfer();
            const files = Array.from(descriptionImagesInput.files);

            files.forEach((file, i) => {
                if (i !== index) {
                    dt.items.add(file);
                }
            });

            descriptionImagesInput.files = dt.files;

            // Refresh preview with remaining files
            const event = new Event('change');
            descriptionImagesInput.dispatchEvent(event);
        };

        // Remove existing image (mark for deletion)
        window.removeExistingImage = function(imageId, button) {
            if (confirm('Bạn có chắc chắn muốn xóa hình ảnh này không?')) {
                // Add to images to remove list
                imagesToRemove.push(imageId);

                // Add hidden field to track images to be removed
                const hiddenField = document.createElement('input');
                hiddenField.type = 'hidden';
                hiddenField.name = 'remove_image_ids[]';
                hiddenField.value = imageId;
                document.getElementById('images-to-remove').appendChild(hiddenField);

                // Remove from display
                const imageElement = document.querySelector(`[data-image-id="${imageId}"]`);
                if (imageElement) {
                    imageElement.remove();
                }
            }
        };

        window.showPlaceholder = function() {
            posterPreview.innerHTML = `
                <div class="bg-light d-flex align-items-center justify-content-center rounded mb-3"
                     style="height: 300px;">
                    <div class="text-center">
                        <i class="fas fa-image fa-3x text-muted mb-2"></i>
                        <p class="text-muted">Không thể tải ảnh</p>
                    </div>
                </div>
            `;
        };
    });
</script>