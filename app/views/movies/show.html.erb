<% content_for :title, @movie.title %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <%= link_to "Quản lý phim", movies_path %>
      </li>
      <li class="breadcrumb-item active"><%= @movie.title %></li>
    </ol>
  </nav>

  <div class="btn-group">
    <%= link_to "Chỉnh sửa", edit_movie_path(@movie),
                class: "btn btn-warning" %>
    <%= link_to toggle_status_movie_path(@movie),
                method: :post,
                class: "btn btn-info" do %>
      <i class="fas fa-toggle-on me-1"></i>
      Chuyển trạng thái
    <% end %>
    <%= link_to movie_path(@movie),
                  method: :delete,
                  data: { turbo_confirm: "Bạn có chắc chắn muốn xóa phim này?" },
                  class: "btn btn-danger" do %>
      <i class="fas fa-trash me-1"></i>
      Xóa phim
    <% end %>
  </div>
</div>

<div class="row">
  <!-- Movie Info -->
  <div class="col-lg-4">
    <div class="card mb-4">
      <div class="card-body text-center">
        <% if @movie.poster_url.present? || @movie.poster_image.present? %>
          <img src="<%= @movie.poster_url || url_for(@movie.poster_image) %>"
               alt="<%= @movie.title %>"
               class="img-fluid rounded mb-3"
               style="max-height: 400px;">
        <% else %>
          <div class="bg-light d-flex align-items-center justify-content-center rounded mb-3"
               style="height: 400px;">
            <i class="fas fa-image fa-3x text-muted"></i>
          </div>
        <% end %>

        <h3><%= @movie.title %></h3>

        <div class="mb-3">
          <% case @movie.status %>
          <% when 'active' %>
            <span class="badge bg-success fs-6">Đang chiếu</span>
          <% when 'inactive' %>
            <span class="badge bg-secondary fs-6">Không hoạt động</span>
          <% when 'coming_soon' %>
            <span class="badge bg-warning fs-6">Sắp chiếu</span>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Movie Details -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="card-title mb-0">Thông tin phim</h5>
      </div>
      <div class="card-body">
        <table class="table table-sm">
          <tr>
            <th width="40%">Thể loại:</th>
            <td><span class="badge bg-info"><%= @movie.genre.humanize %></span></td>
          </tr>
          <tr>
            <th>Thời lượng:</th>
            <td><%= @movie.duration %> phút</td>
          </tr>
          <tr>
            <th>Độ tuổi:</th>
            <td><span class="badge bg-secondary"><%= @movie.age_rating %></span></td>
          </tr>
          <tr>
            <th>Ngày tạo:</th>
            <td><%= @movie.created_at.strftime("%d/%m/%Y %H:%M") %></td>
          </tr>
          <tr>
            <th>Cập nhật:</th>
            <td><%= @movie.updated_at.strftime("%d/%m/%Y %H:%M") %></td>
          </tr>
        </table>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="col-lg-8">
    <!-- Description -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="card-title mb-0">Mô tả phim</h5>
      </div>
      <div class="card-body">
        <% if @movie.description.present? %>
          <p><%= simple_format(@movie.description) %></p>
        <% else %>
          <p class="text-muted">Chưa có mô tả</p>
        <% end %>
      </div>
    </div>

    <!-- Statistics -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="card-title mb-0">Thống kê</h5>
      </div>
      <div class="card-body">
        <div class="row text-center">
          <div class="col-md-3">
            <div class="bg-primary bg-opacity-10 rounded p-3">
              <h4 class="text-primary text-white mb-1"><%= @stats[:total_showtimes] %></h4>
              <small class="text-white">Tổng suất chiếu</small>
            </div>
          </div>
          <div class="col-md-3">
            <div class="bg-info bg-opacity-10 rounded p-3">
              <h4 class="text-info text-white mb-1"><%= @stats[:upcoming_showtimes] %></h4>
              <small class="text-white">Suất sắp chiếu</small>
            </div>
          </div>
          <div class="col-md-3">
            <div class="bg-success bg-opacity-10 rounded p-3">
              <h4 class="text-success text-white mb-1"><%= @stats[:total_bookings] %></h4>
              <small class="text-white">Vé đã bán</small>
            </div>
          </div>
          <div class="col-md-3">
            <div class="bg-warning bg-opacity-10 rounded p-3">
              <h4 class="text-warning text-white mb-1">
                <%= number_to_currency(@stats[:total_revenue], unit: "₫", delimiter: ",") %>
              </h4>
              <small class="text-white">Doanh thu</small>
            </div>
          </div>
        </div>

        <div class="row mt-3 text-center">
          <div class="col-md-6">
            <div class="bg-secondary bg-opacity-10 rounded p-3">
              <h4 class="text-secondary text-white mb-1">
                <%= @stats[:average_rating] ? number_with_precision(@stats[:average_rating], precision: 1) : "N/A" %>
                <i class="fas fa-star text-warning"></i>
              </h4>
              <small class="text-white">Điểm trung bình</small>
            </div>
          </div>
          <div class="col-md-6">
            <div class="bg-dark bg-opacity-10 rounded p-3">
              <h4 class="text-dark text-white mb-1"><%= @stats[:total_reviews] %></h4>
              <small class="text-white">Tổng đánh giá</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Showtimes -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Suất chiếu sắp tới</h5>
        <%= link_to "Quản lý suất chiếu", "#", class: "btn btn-sm btn-outline-primary" %>
      </div>
      <div class="card-body">
        <% if @showtimes.any? %>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
              <tr>
                <th>Ngày chiếu</th>
                <th>Giờ chiếu</th>
                <th>Phòng chiếu</th>
                <th>Trạng thái</th>
              </tr>
              </thead>
              <tbody>
              <% @showtimes.first(10).each do |showtime| %>
                <tr>
                  <td><%= showtime.show_date.strftime("%d/%m/%Y") %></td>
                  <td><%= showtime.show_time.strftime("%H:%M") %></td>
                  <td><%= showtime.screen.screen_name if showtime.screen %></td>
                  <td>
                    <span class="badge bg-success">Hoạt động</span>
                  </td>
                </tr>
              <% end %>
              </tbody>
            </table>
          </div>
          <% if @showtimes.count > 10 %>
            <p class="text-muted text-center mt-3">
              Hiển thị 10/<%= @showtimes.count %> suất chiếu
            </p>
          <% end %>
        <% else %>
          <p class="text-muted text-center">Chưa có suất chiếu nào</p>
        <% end %>
      </div>
    </div>

    <!-- Reviews -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Đánh giá gần đây</h5>
        <%= link_to "Xem tất cả", "#", class: "btn btn-sm btn-outline-primary" %>
      </div>
      <div class="card-body">
        <% if @reviews.any? %>
          <% @reviews.each do |review| %>
            <div class="border-bottom pb-3 mb-3">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <strong><%= review.player.first_name if review.player %></strong>
                  <div class="text-warning">
                    <% review.rating.times do %>
                      <i class="fas fa-star"></i>
                    <% end %>
                    <% (5 - review.rating).times do %>
                      <i class="far fa-star"></i>
                    <% end %>
                  </div>
                </div>
                <small class="text-muted">
                  <%= time_ago_in_words(review.created_at) %> trước
                </small>
              </div>
              <p class="mb-0 mt-2"><%= review.comment %></p>
            </div>
          <% end %>
        <% else %>
          <p class="text-muted text-center">Chưa có đánh giá nào</p>
        <% end %>
      </div>
    </div>
  </div>
</div>