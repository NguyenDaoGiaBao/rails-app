<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Quản lý Suất chiếu</h1>
    <%= link_to "Thêm suất chiếu mới", new_showtime_path, class: "btn btn-primary" %>
  </div>

  <!-- Filters -->
  <div class="card mb-4">
    <div class="card-body">
      <%= form_with url: showtimes_path, method: :get, class: "row g-3" do |f| %>
        <div class="col-md-3">
          <%= f.label :date, "Ngày chiếu", class: "form-label" %>
          <%= f.date_field :date, value: params[:date], class: "form-control" %>
        </div>

        <div class="col-md-3">
          <%= f.label :movie_id, "Phim", class: "form-label" %>
          <%= f.select :movie_id,
                       options_from_collection_for_select(Movie.all, :id, :title, params[:movie_id]),
                       { include_blank: "Tất cả" },
                       class: "form-select" %>
        </div>

        <div class="col-md-3">
          <%= f.label :status, "Trạng thái", class: "form-label" %>
          <%= f.select :status,
                       options_for_select([
                                            ["Tất cả", ""],
                                            ["Đang hoạt động", "active"],
                                            ["Ngừng hoạt động", "inactive"],
                                            ["Hết vé", "sold_out"]
                                          ], params[:status]),
                       {},
                       class: "form-select" %>
        </div>

        <div class="col-md-3 d-flex align-items-end">
          <%= f.submit "Lọc", class: "btn btn-secondary me-2" %>
          <%= link_to "Xóa bộ lọc", showtimes_path, class: "btn btn-outline-secondary" %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Showtimes Table -->
  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
          <tr>
            <th>ID</th>
            <th>Phim</th>
            <th>Phòng chiếu</th>
            <th>Ngày chiếu</th>
            <th>Giờ chiếu</th>
            <th>Giá vé</th>
            <th>Ghế trống</th>
            <th>Trạng thái</th>
            <th>Hành động</th>
          </tr>
          </thead>
          <tbody>
          <% @showtimes.each do |showtime| %>
            <tr>
              <td><%= showtime.id %></td>
              <td><%= showtime.movie.title %></td>
              <td><%= showtime.screen.screen_name %></td>
              <td><%= showtime.show_date.strftime("%d/%m/%Y") %></td>
              <td><%= showtime.show_time.strftime("%H:%M") %></td>
              <td>
                <small>
                  Thường: <%= number_to_currency(showtime.regular_price, unit: "đ", format: "%n%u") %><br>
                  VIP: <%= number_to_currency(showtime.vip_price, unit: "đ", format: "%n%u") %><br>
                  Đôi: <%= number_to_currency(showtime.couple_price, unit: "đ", format: "%n%u") %>
                </small>
              </td>
              <td>
                <%= showtime.available_seats %>/<%= showtime.total_seats %>
                <div class="progress" style="height: 5px;">
                  <div class="progress-bar" role="progressbar"
                       style="width: <%= (showtime.available_seats.to_f / showtime.total_seats * 100).round %>%">
                  </div>
                </div>
              </td>
              <td>
                <% case showtime.status %>
                <% when "active" %>
                  <span class="badge bg-success">Đang hoạt động</span>
                <% when "inactive" %>
                  <span class="badge bg-secondary">Ngừng hoạt động</span>
                <% when "sold_out" %>
                  <span class="badge bg-danger">Hết vé</span>
                <% end %>
              </td>
              <td>
                <%= link_to "Xem", showtime_path(showtime), class: "btn btn-sm btn-info" %>
                <%= link_to "Sửa", edit_showtime_path(showtime), class: "btn btn-sm btn-warning" %>
                <%= link_to "Xóa",
                            class: "btn btn-sm btn-danger btn-delete-movie",
                            data: { id: showtime.id, url: showtime_path(showtime) } do %>Xóa<% end %>
              </td>
            </tr>
          <% end %>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="mt-3">
        <%= paginate @showtimes %>
      </div>
    </div>
  </div>
</div>
<% content_for :scripts do %>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
      document.addEventListener('DOMContentLoaded', function() {
          document.querySelectorAll('.btn-delete-movie').forEach(function(button) {
              button.addEventListener('click', function(e) {
                  e.preventDefault();

                  const url = this.dataset.url;

                  Swal.fire({
                      title: 'Bạn có chắc muốn xóa?',
                      text: "Hành động này không thể hoàn tác!",
                      icon: 'warning',
                      showCancelButton: true,
                      confirmButtonColor: '#e7515a',
                      cancelButtonColor: '#3b3f5c',
                      confirmButtonText: 'Vâng, xóa nó!'
                  }).then((result) => {
                      if (result.isConfirmed) {
                          const form = document.createElement('form');
                          form.method = 'post';
                          form.action = url;

                          const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
                          const csrfInput = document.createElement('input');
                          csrfInput.type = 'hidden';
                          csrfInput.name = 'authenticity_token';
                          csrfInput.value = csrfToken;
                          form.appendChild(csrfInput);

                          // input method delete
                          const methodInput = document.createElement('input');
                          methodInput.type = 'hidden';
                          methodInput.name = '_method';
                          methodInput.value = 'delete';
                          form.appendChild(methodInput);

                          document.body.appendChild(form);
                          form.submit();
                      }
                  });
              });
          });
      });
  </script>
<% end %>