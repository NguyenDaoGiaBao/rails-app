<%= form_with(model: showtime, local: true) do |f| %>
  <% if showtime.errors.any? %>
    <div class="alert alert-danger">
      <h4><%= pluralize(showtime.errors.count, "lỗi") %> đã xảy ra:</h4>
      <ul>
        <% showtime.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="row">
    <div class="col-md-6">
      <div class="mb-3">
        <%= f.label :movie_id, "Phim", class: "form-label" %>
        <%= f.select :movie_id,
                     options_from_collection_for_select(@movies, :id, :title, showtime.movie_id),
                     { prompt: "Chọn phim" },
                     class: "form-select",
                     required: true %>
      </div>
    </div>

    <div class="col-md-6">
      <div class="mb-3">
        <%= f.label :screen_id, "Phòng chiếu", class: "form-label" %>
        <%= f.select :screen_id,
                     options_from_collection_for_select(@screens, :id, :screen_name, showtime.screen_id),
                     { prompt: "Chọn phòng chiếu" },
                     class: "form-select",
                     required: true %>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6">
      <div class="mb-3">
        <%= f.label :show_date, "Ngày chiếu", class: "form-label" %>
        <%= f.date_field :show_date, class: "form-control", required: true %>
      </div>
    </div>

    <div class="col-md-6">
      <div class="mb-3">
        <%= f.label :show_time, "Giờ chiếu", class: "form-label" %>
        <%= f.time_field :show_time, class: "form-control", required: true %>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-4">
      <div class="mb-3">
        <%= f.label :regular_price, "Giá ghế thường (đ)", class: "form-label" %>
        <%= f.number_field :regular_price,
                           class: "form-control",
                           step: "1000",
                           min: "0",
                           required: true %>
      </div>
    </div>

    <div class="col-md-4">
      <div class="mb-3">
        <%= f.label :vip_price, "Giá ghế VIP (đ)", class: "form-label" %>
        <%= f.number_field :vip_price,
                           class: "form-control",
                           step: "1000",
                           min: "0",
                           required: true %>
      </div>
    </div>

    <div class="col-md-4">
      <div class="mb-3">
        <%= f.label :couple_price, "Giá ghế đôi (đ)", class: "form-label" %>
        <%= f.number_field :couple_price,
                           class: "form-control",
                           step: "1000",
                           min: "0",
                           required: true %>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-4">
      <div class="mb-3">
        <%= f.label :total_seats, "Tổng số ghế", class: "form-label" %>
        <%= f.number_field :total_seats,
                           class: "form-control",
                           min: "0",
                           required: true %>
      </div>
    </div>

    <div class="col-md-4">
      <div class="mb-3">
        <%= f.label :available_seats, "Số ghế còn trống", class: "form-label" %>
        <%= f.number_field :available_seats,
                           class: "form-control",
                           min: "0",
                           required: true %>
      </div>
    </div>

    <div class="col-md-4">
      <div class="mb-3">
        <%= f.label :status, "Trạng thái", class: "form-label" %>
        <%= f.select :status,
                     options_for_select([
                                          ["Đang hoạt động", "active"],
                                          ["Ngừng hoạt động", "inactive"],
                                          ["Hết vé", "sold_out"]
                                        ], showtime.status),
                     {},
                     class: "form-select" %>
      </div>
    </div>
  </div>

  <div class="mb-3">
    <%= f.submit showtime.new_record? ? "Tạo suất chiếu" : "Cập nhật suất chiếu",
                 class: "btn btn-primary" %>
    <%= link_to "Hủy", showtimes_path, class: "btn btn-secondary" %>
  </div>
<% end %>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const showtimeSelect = document.getElementById("showtime_screen_id");
        const seatInput = document.getElementById("showtime_total_seats");
        const seatAvailableInput = document.getElementById("showtime_available_seats");

        showtimeSelect.addEventListener("change", async (e) => {
            const screenId = e.target.value;
            if (!screenId) {
                seatInput.value = "";
                return;
            }
            try {
                const response = await fetch(`/screens/${screenId}/seats`);
                if (!response.ok) throw new Error("Request failed");

                const data = await response.json();
                if (data.total_seats) {
                    seatInput.value = data.total_seats;
                    seatAvailableInput.value = data.total_seats;
                }
            } catch (error) {
                console.error("Lỗi khi lấy số ghế:", error);
            }
        });
    });
</script>